<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E_INK_Timer</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* --- 主题配置 --- */
        :root {
            --bg-color: #dcdcdc;
            --pixel-pattern: radial-gradient(#b0b0b0 10%, transparent 10%);
            --ink-color: #1a1a1a;
            --screen-bg: #d0d3d4;
            --border-color: #1a1a1a;
            --invert-bg: #1a1a1a;
            --invert-ink: #dcdcdc;
            --shadow: 4px 4px 0px rgba(0,0,0,0.2);
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --pixel-pattern: radial-gradient(#333 10%, transparent 10%);
            --ink-color: #dcdcdc;
            --screen-bg: #2a2a2a;
            --border-color: #dcdcdc;
            --invert-bg: #dcdcdc;
            --invert-ink: #1a1a1a;
            --shadow: 4px 4px 0px #000;
        }

        [data-theme="gameboy"] {
            --bg-color: #8b9c0f;
            --pixel-pattern: none;
            --ink-color: #0f380f;
            --screen-bg: #9bbc0f;
            --border-color: #0f380f;
            --invert-bg: #0f380f;
            --invert-ink: #9bbc0f;
            --shadow: 4px 4px 0px #0f380f;
        }

        /* --- 基础布局 --- */
        * { box-sizing: border-box; user-select: none; }
        
        body {
            background-color: var(--bg-color);
            color: var(--ink-color);
            font-family: 'VT323', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-image: var(--pixel-pattern);
            background-size: 4px 4px;
            transition: all 0.3s ease;
        }

        /* 左侧悬浮组件容器 */
        .left-widgets {
            position: fixed;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
            max-height: 90vh; /* 防止过长溢出 */
        }

        .widget-box {
            background: var(--bg-color);
            border: 2px solid var(--ink-color);
            padding: 5px 8px;
            font-size: 1.1rem;
            box-shadow: 2px 2px 0 var(--ink-color);
            min-width: 160px;
            max-width: 200px;
        }
        
        .widget-title {
            border-bottom: 1px dashed var(--ink-color);
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        /* 日志列表样式 */
        #log-list {
            max-height: 250px;
            overflow-y: auto;
            font-size: 0.95rem;
        }
        .log-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px dotted var(--border-color);
            padding: 3px 0;
            flex-wrap: wrap;
        }
        .log-info { width: 100%; display: flex; justify-content: space-between; }
        .log-actions { width: 100%; text-align: right; margin-top: 2px; opacity: 0.6; font-size: 0.8rem; }
        .log-actions span { cursor: pointer; margin-left: 8px; text-decoration: underline; }
        .log-actions span:hover { opacity: 1; font-weight: bold; }

        /* 天气组件微调 */
        #weather-widget { cursor: pointer; }

        /* 主容器 */
        .container {
            width: 90%;
            max-width: 440px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-bottom: 20px;
            padding-top: 20px; 
            margin-left: 180px; /* 给左侧组件留出空间，防止遮挡 */
        }
        @media (max-width: 768px) {
            .container { margin-left: 0; padding-top: 120px; } /* 移动端适配 */
            .left-widgets { flex-direction: row; flex-wrap: wrap; }
        }

        /* 像素框通用样式 */
        .pixel-box {
            background: var(--bg-color);
            border: 3px solid var(--border-color);
            box-shadow: var(--shadow);
            padding: 15px;
            position: relative;
        }

        /* 顶部工具栏 */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .text-btn {
            background: transparent;
            border: none;
            color: var(--ink-color);
            font-family: 'VT323';
            font-size: 1.1rem;
            cursor: pointer;
            text-transform: uppercase;
            padding: 0 5px;
        }
        .text-btn:hover { text-decoration: underline; font-weight: bold; }

        /* 计时器显示区 */
        .timer-display {
            font-size: 5.5rem;
            text-align: center;
            background: var(--screen-bg);
            border: 2px inset var(--border-color);
            margin: 10px 0;
            line-height: 0.9;
            padding: 10px 0;
            cursor: pointer;
        }

        /* 输入控件 */
        .task-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
            font-size: 1.2rem;
            flex-wrap: wrap;
        }
        input[type="text"], input[type="number"], input[type="time"] {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--ink-color);
            font-family: 'VT323';
            font-size: 1.2rem;
            padding: 4px;
            outline: none;
        }
        #currentTask { flex-grow: 1; text-transform: uppercase; }
        
        .mode-switch {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 1.1rem;
            margin-left: 10px;
        }

        /* 按钮组 */
        .controls { display: flex; justify-content: center; gap: 10px; }
        button.action-btn {
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            color: var(--ink-color);
            font-family: 'VT323';
            font-size: 1.3rem;
            padding: 5px 20px;
            cursor: pointer;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.2);
            text-transform: uppercase;
        }
        button.action-btn:active { transform: translate(2px, 2px); box-shadow: none; }
        button.primary { background: var(--ink-color); color: var(--bg-color); }
        button.finish-btn { border-style: dashed; }

        /* 统计图表区域 */
        .stats-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: var(--bg-color); 
        }
        .chart-row { display: flex; align-items: center; gap: 20px; }
        
        #pieChartCanvas {
            border: 2px solid var(--border-color);
            border-radius: 50%;
            background: var(--bg-color);
        }

        .legend { font-size: 1rem; max-height: 120px; overflow-y: auto; width: 100%; }
        .legend-item { display: flex; justify-content: space-between; margin-bottom: 2px; border-bottom: 1px dotted var(--border-color); }

        /* Zen 模式 */
        body.zen-active .hide-in-zen { display: none !important; }
        body.zen-active .left-widgets { opacity: 0.1; pointer-events: none; }
        body.zen-active .container { width: 100%; max-width: none; height: 100vh; justify-content: center; padding: 0; margin: 0; }
        body.zen-active .timer-display { font-size: 25vw; border: none; background: transparent; padding: 0; margin: 0; }
        body.zen-active .pixel-box { border: none; box-shadow: none; background: transparent; }

        /* 反色模式 */
        body.break-mode {
            background-color: var(--invert-bg);
            color: var(--invert-ink);
            background-image: none;
        }
        body.break-mode .pixel-box, body.break-mode .timer-display, body.break-mode .widget-box {
            background: var(--invert-bg);
            border-color: var(--invert-ink);
            color: var(--invert-ink);
        }
        body.break-mode button {
            border-color: var(--invert-ink);
            color: var(--invert-ink);
            background: var(--invert-bg);
        }
        
        .disabled-input { opacity: 0.3; pointer-events: none; }
        
        /* 滚动条美化 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--ink-color); }
    </style>
</head>
<body>

<div class="left-widgets">
    <div class="widget-box" id="day-countdown-widget" title="Time until End of Day">
        <div class="widget-title">DAY LEFT</div>
        <div id="dayLeft" style="font-size:1.4rem; text-align:center;">--:--</div>
    </div>
    
    <div class="widget-box" id="weather-widget" onclick="fetchWeather()" title="Click to refresh">
        <div class="widget-title">WEATHER</div>
        <div id="weatherDisplay" style="text-align:center;">LOADING...</div>
    </div>

    <div class="widget-box" id="log-widget">
        <div class="widget-title">
            <span>TODAY'S LOG</span>
            <span style="font-size:0.8rem; cursor:pointer;" onclick="exportDataTxt()">[SAVE]</span>
        </div>
        <div id="log-list">
            <div style="text-align:center; color:#888;">NO RECORDS</div>
        </div>
    </div>
</div>

<div class="container">
    <div class="pixel-box hide-in-zen">
        <div class="toolbar" style="margin:0;">
            <div style="font-weight:bold; font-size:1.4rem;">E_INK_Timer</div>
            <div>
                <button class="text-btn" onclick="toggleTheme()">[THEME]</button>
                <button class="text-btn" onclick="toggleZen()">[ZEN]</button>
            </div>
        </div>
    </div>

    <div class="pixel-box" id="timerBox">
        <div class="hide-in-zen">
            <div class="task-input-group">
                <span>TASK:</span>
                <input type="text" id="currentTask" value="FOCUS" placeholder="What are you doing?">
            </div>
            
            <div class="task-input-group" style="justify-content: space-between; margin-top:10px; align-items: flex-end;">
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <div id="countdown-inputs">
                        <span>TIME:</span>
                        <input type="number" id="workMin" value="25" style="width:50px; text-align:center"> m
                    </div>
                    <div class="mode-switch" onclick="toggleCountUpMode()">
                        <span id="countUpCheck">[ ]</span> COUNT UP
                    </div>
                </div>

                <div style="text-align: right;">
                    <div style="font-size: 0.9rem; margin-bottom: 2px;">END OF DAY:</div>
                    <input type="time" id="endOfDayTime" value="18:00" onchange="saveSettings()">
                </div>
            </div>
        </div>

        <div class="timer-display" id="display" onclick="toggleZen()" title="Click for Zen Mode">25:00</div>

        <div class="controls hide-in-zen">
            <button class="action-btn primary" onclick="toggleTimer()" id="mainBtn">START</button>
            <button class="action-btn finish-btn" onclick="finishEarly()" id="finishBtn" style="display:none;">DONE</button>
            <button class="action-btn" onclick="resetTimer()" id="resetBtn">RESET</button>
        </div>
    </div>

    <div class="pixel-box hide-in-zen" id="statsBox">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:2px solid var(--border-color);">
            <div style="font-weight:bold;">DAILY STATS</div>
            <button class="text-btn" onclick="shareStatsImage()" title="Save as Image" style="font-size:0.9rem;">[SHARE IMG]</button>
        </div>
        
        <div style="margin-bottom:5px; font-size:0.9rem;">
            TOTAL FOCUS: <span id="totalTime">0</span>m | <span id="dateDisplay"></span>
        </div>

        <div class="stats-container">
            <div class="chart-row">
                <canvas id="pieChartCanvas" width="100" height="100"></canvas>
                <div class="legend" id="legend">
                    <div style="text-align:center; color:#888;">NO DATA YET</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    /* --- 全局状态 --- */
    const state = {
        timeLeft: 25 * 60, isRunning: false, isWorkMode: true, isCountUp: false, isZen: false,
        timerId: null, elapsedTime: 0, initialDuration: 0, startTimeStr: null,
        themes: ['default', 'dark', 'gameboy'], currentThemeIdx: 0
    };

    /* --- 数据 --- */
    let activityLog = JSON.parse(localStorage.getItem('inkActivityLog')) || [];
    let savedEndTime = localStorage.getItem('inkEndTime') || "18:00";

    /* --- DOM --- */
    const els = {
        display: document.getElementById('display'),
        workMin: document.getElementById('workMin'),
        mainBtn: document.getElementById('mainBtn'),
        finishBtn: document.getElementById('finishBtn'),
        dayLeft: document.getElementById('dayLeft'),
        endOfDayInput: document.getElementById('endOfDayTime'),
        taskInput: document.getElementById('currentTask'),
        countUpCheck: document.getElementById('countUpCheck'),
        countdownInputs: document.getElementById('countdown-inputs'),
        weatherDisplay: document.getElementById('weatherDisplay'),
        pieCanvas: document.getElementById('pieChartCanvas'),
        legend: document.getElementById('legend'),
        totalTime: document.getElementById('totalTime'),
        dateDisplay: document.getElementById('dateDisplay'),
        statsBox: document.getElementById('statsBox'),
        logList: document.getElementById('log-list')
    };

    els.endOfDayInput.value = savedEndTime;
    els.dateDisplay.textContent = new Date().toLocaleDateString();

    /* --- 1. 左侧组件逻辑 --- */
    // 天气
    function fetchWeather() {
        els.weatherDisplay.textContent = "LOCATING...";
        if (!navigator.geolocation) { els.weatherDisplay.textContent = "NO GPS"; return; }
        navigator.geolocation.getCurrentPosition((pos) => {
            const { latitude, longitude } = pos.coords;
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`)
                .then(res => res.json())
                .then(data => {
                    const codes = { 0:"CLEAR", 1:"CLEAR", 2:"CLOUDY", 3:"OVERCAST", 45:"FOG", 51:"RAIN", 61:"RAIN", 71:"SNOW", 80:"SHOWER", 95:"STORM" };
                    const desc = codes[data.current_weather.weathercode] || "UNKNOWN";
                    els.weatherDisplay.textContent = `${Math.round(data.current_weather.temperature)}° ${desc}`;
                }).catch(() => els.weatherDisplay.textContent = "ERR:NET");
        }, () => els.weatherDisplay.textContent = "GPS DENIED");
    }
    setTimeout(fetchWeather, 1000);

    // 下班倒计时
    function updateDayLeft() {
        const now = new Date();
        const [th, tm] = els.endOfDayInput.value.split(':').map(Number);
        const target = new Date(now); target.setHours(th, tm, 0, 0);
        let diff = target - now;
        
        if (diff < 0) {
            els.dayLeft.textContent = "FREE TIME";
            els.dayLeft.style.color = "inherit";
        } else {
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            if (h === 0) {
                const s = Math.floor((diff % 60000) / 1000);
                els.dayLeft.textContent = `${m}m ${s}s`;
                els.dayLeft.style.color = (m < 30 && m % 2 !== 0) ? 'var(--ink-color)' : 'inherit';
            } else {
                els.dayLeft.textContent = `${h}h ${m}m`;
                els.dayLeft.style.color = 'inherit';
            }
        }
    }
    setInterval(updateDayLeft, 1000);
    function saveSettings() { localStorage.setItem('inkEndTime', els.endOfDayInput.value); updateDayLeft(); }

    /* --- 2. 活动记录组件 (Log Widget) --- */
    function renderLogWidget() {
        const today = new Date().toLocaleDateString();
        // 获取今日数据，并附带原始索引以便修改
        const logs = activityLog.map((item, index) => ({...item, originalIndex: index}))
                                .filter(item => item.date === today)
                                .reverse(); // 新的在上面

        if (logs.length === 0) {
            els.logList.innerHTML = '<div style="text-align:center; color:#888; padding-top:10px;">NO RECORDS TODAY</div>';
            return;
        }

        let html = '';
        logs.forEach(log => {
            html += `
            <div class="log-item">
                <div class="log-info">
                    <span>${log.startTime || '--:--'}</span>
                    <span style="font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:80px;" title="${log.task}">${log.task}</span>
                    <span>${log.duration}m</span>
                </div>
                <div class="log-actions">
                    <span onclick="editLog(${log.originalIndex})">[E]</span>
                    <span onclick="deleteLog(${log.originalIndex})" style="color:red">[X]</span>
                </div>
            </div>`;
        });
        els.logList.innerHTML = html;
    }

    function deleteLog(index) {
        if(confirm("Delete this record?")) {
            activityLog.splice(index, 1);
            saveDataAndRender();
        }
    }

    function editLog(index) {
        const log = activityLog[index];
        const newName = prompt("Edit Task Name:", log.task);
        if (newName === null) return; // Cancelled
        
        const newDurationStr = prompt("Edit Duration (minutes):", log.duration);
        if (newDurationStr === null) return;
        
        const newDuration = parseInt(newDurationStr);
        if (isNaN(newDuration) || newDuration < 1) {
            alert("Invalid duration.");
            return;
        }

        // Update
        activityLog[index].task = newName.trim() || "UNNAMED";
        activityLog[index].duration = newDuration;
        saveDataAndRender();
    }

    function saveDataAndRender() {
        localStorage.setItem('inkActivityLog', JSON.stringify(activityLog));
        renderLogWidget();
        renderStats(); // 联动更新饼状图
    }

    /* --- 3. 截图分享逻辑 --- */
    function shareStatsImage() {
        const target = els.statsBox;
        const originalBorder = target.style.border;
        target.style.border = "3px solid var(--ink-color)";
        renderStats(); 
        html2canvas(target, {
            backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-color').trim(),
            scale: 2
        }).then(canvas => {
            target.style.border = originalBorder;
            const link = document.createElement('a');
            const dateStr = new Date().toISOString().slice(0, 10);
            link.download = `E_INK_Stats_${dateStr}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }).catch(err => {
            console.error(err);
            alert("Screenshot failed.");
        });
    }

    /* --- 4. 计时器逻辑 --- */
    function toggleCountUpMode() {
        if(state.isRunning) return;
        state.isCountUp = !state.isCountUp;
        els.countUpCheck.textContent = state.isCountUp ? "[x]" : "[ ]";
        if (state.isCountUp) {
            els.countdownInputs.classList.add('disabled-input');
            updateDisplay(0);
        } else {
            els.countdownInputs.classList.remove('disabled-input');
            updateDisplay(els.workMin.value * 60);
        }
    }

    function updateDisplay(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        els.display.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        const icon = state.isCountUp ? '▲' : '▼';
        document.title = `(${els.display.textContent}) ${state.isRunning ? icon : ''} E_INK_Timer`;
    }

    function toggleTimer() {
        if (state.isRunning) {
            clearInterval(state.timerId);
            state.isRunning = false;
            els.mainBtn.textContent = "RESUME";
            els.finishBtn.style.display = "none";
        } else {
            if (!state.startTimeStr) {
                const now = new Date();
                state.startTimeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            }
            if (!state.isCountUp && (state.timeLeft === els.workMin.value * 60 || state.timeLeft === 0)) {
                 state.timeLeft = els.workMin.value * 60;
                 state.initialDuration = state.timeLeft;
            }
            state.isRunning = true;
            els.mainBtn.textContent = "PAUSE";
            els.finishBtn.style.display = "inline-block";
            state.timerId = setInterval(() => {
                if (state.isCountUp) {
                    state.elapsedTime++;
                    updateDisplay(state.elapsedTime);
                } else {
                    if (state.timeLeft > 0) {
                        state.timeLeft--;
                        updateDisplay(state.timeLeft);
                    } else {
                        finishTimer(true);
                    }
                }
            }, 1000);
        }
    }

    function finishTimer(natural) {
        clearInterval(state.timerId);
        state.isRunning = false;
        els.mainBtn.textContent = "START";
        els.finishBtn.style.display = "none";
        let duration = state.isCountUp ? Math.ceil(state.elapsedTime/60) : (natural ? Math.ceil(state.initialDuration/60) : Math.ceil((state.initialDuration - state.timeLeft)/60));
        if(duration < 1) duration = 1;
        
        if(natural) { beep(); alert("Time's Up!"); }
        
        activityLog.push({ date: new Date().toLocaleDateString(), startTime: state.startTimeStr, task: els.taskInput.value.trim() || "UNNAMED", duration: duration });
        
        state.startTimeStr = null;
        state.elapsedTime = 0;
        if (!state.isCountUp) { state.timeLeft = els.workMin.value * 60; updateDisplay(state.timeLeft); }
        else { updateDisplay(0); }

        saveDataAndRender(); // 保存并更新所有UI
    }

    function finishEarly() { finishTimer(false); }

    function beep() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator(); const g = ctx.createGain();
        osc.connect(g); g.connect(ctx.destination);
        osc.type = 'square'; osc.frequency.value = 800;
        g.gain.setValueAtTime(0.1, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.5);
        osc.start(); osc.stop(ctx.currentTime+0.5);
    }

    /* --- 5. 统计绘制 (Canvas) --- */
    function renderStats() {
        const today = new Date().toLocaleDateString();
        const logs = activityLog.filter(l => l.date === today);
        const map = {}; let total = 0;
        logs.forEach(l => { map[l.task] = (map[l.task]||0)+l.duration; total+=l.duration; });
        els.totalTime.textContent = total;
        
        const ctx = els.pieCanvas.getContext('2d');
        const width = els.pieCanvas.width;
        const height = els.pieCanvas.height;
        const centerX = width / 2;
        const centerY = height / 2;
        const radius = width / 2;

        ctx.clearRect(0, 0, width, height);

        if (total === 0) {
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--border-color'); 
            ctx.globalAlpha = 0.2;
            ctx.fill();
            ctx.globalAlpha = 1.0;
            els.legend.innerHTML = '<div style="text-align:center; color:#888;">NO DATA</div>';
            return;
        }

        let startAngle = 0;
        let html = '';
        const inkColor = getComputedStyle(document.body).getPropertyValue('--ink-color').trim();
        const bgColor = getComputedStyle(document.body).getPropertyValue('--bg-color').trim();
        const borderColor = getComputedStyle(document.body).getPropertyValue('--border-color').trim();
        const dynamicShades = [inkColor, '#777', '#999', '#bbb', borderColor];

        Object.keys(map).forEach((k, i) => {
            const pct = map[k]/total;
            const sliceAngle = pct * 2 * Math.PI;
            const color = dynamicShades[i % dynamicShades.length];

            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
            ctx.closePath();
            ctx.fillStyle = color;
            ctx.fill();

            ctx.lineWidth = 1;
            ctx.strokeStyle = bgColor;
            ctx.stroke();

            html += `
                <div class="legend-item">
                    <div style="display:flex;align-items:center;">
                        <span style="width:10px;height:10px;background:${color};border:1px solid var(--border-color);margin-right:5px;"></span>
                        <span>${k}</span>
                    </div>
                    <span>${map[k]}m</span>
                </div>`;
            startAngle += sliceAngle;
        });
        els.legend.innerHTML = html;
    }

    function toggleTheme() {
        state.currentThemeIdx = (state.currentThemeIdx + 1) % state.themes.length;
        document.documentElement.setAttribute('data-theme', state.themes[state.currentThemeIdx]);
        renderStats();
    }
    
    function toggleZen() {
        state.isZen = !state.isZen;
        document.body.classList.toggle('zen-active', state.isZen);
    }
    document.addEventListener('keydown', e => { if(state.isZen && e.key === 'Enter') toggleZen(); });

    function exportDataTxt() {
        if(activityLog.length === 0) { alert("No records yet."); return; }
        let txtContent = "=== E_INK TIMER LOG ===\n\nDATE        | START | TASK                 | DURATION\n---------------------------------------------------\n";
        [...activityLog].reverse().forEach(log => {
            txtContent += `${log.date.padEnd(11,' ')} | ${(log.startTime||"--:--").padEnd(5,' ')} | ${(log.task).padEnd(20,' ')} | ${(log.duration+"m").padEnd(8,' ')}\n`;
        });
        const blob = new Blob([txtContent], {type: 'text/plain'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `E_INK_Log_${new Date().toISOString().slice(0,10)}.txt`; a.click();
    }

    /* --- 初始化 --- */
    renderLogWidget(); // 渲染左侧日志
    renderStats();     // 渲染右侧饼图
    els.workMin.addEventListener('change', () => { if (!state.isRunning && !state.isCountUp) { state.timeLeft = els.workMin.value*60; updateDisplay(state.timeLeft); }});
</script>
</body>
</html>
