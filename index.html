<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E_INK_Timer</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* --- 主题配置 --- */
        :root {
            --bg-color: #dcdcdc;
            --pixel-pattern: radial-gradient(#b0b0b0 10%, transparent 10%);
            --ink-color: #1a1a1a;
            --screen-bg: #d0d3d4;
            --border-color: #1a1a1a;
            --invert-bg: #1a1a1a;
            --invert-ink: #dcdcdc;
            --shadow: 4px 4px 0px rgba(0,0,0,0.2);
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --pixel-pattern: radial-gradient(#333 10%, transparent 10%);
            --ink-color: #dcdcdc;
            --screen-bg: #2a2a2a;
            --border-color: #dcdcdc;
            --invert-bg: #dcdcdc;
            --invert-ink: #1a1a1a;
            --shadow: 4px 4px 0px #000;
        }

        [data-theme="gameboy"] {
            --bg-color: #8b9c0f;
            --pixel-pattern: none;
            --ink-color: #0f380f;
            --screen-bg: #9bbc0f;
            --border-color: #0f380f;
            --invert-bg: #0f380f;
            --invert-ink: #9bbc0f;
            --shadow: 4px 4px 0px #0f380f;
        }

        /* --- 基础布局 --- */
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-color);
            color: var(--ink-color);
            font-family: 'VT323', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-image: var(--pixel-pattern);
            background-size: 4px 4px;
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        /* --- 左侧悬浮组件容器 (可折叠) --- */
        .left-widgets {
            position: fixed;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 500;
            max-height: 90vh;
            width: 220px;
            pointer-events: none;
        }

        #widget-toggle-btn {
            pointer-events: auto;
            align-self: flex-start;
            background: var(--bg-color);
            border: 2px solid var(--ink-color);
            color: var(--ink-color);
            font-family: 'VT323';
            font-size: 1.2rem;
            padding: 2px 8px;
            cursor: pointer;
            box-shadow: 2px 2px 0 var(--shadow);
            margin-bottom: 5px;
        }

        .widget-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform-origin: top left;
        }

        .widget-container.collapsed {
            opacity: 0;
            transform: scaleY(0);
            height: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .widget-box {
            background: var(--bg-color);
            border: 2px solid var(--ink-color);
            padding: 5px 8px;
            font-size: 1.1rem;
            box-shadow: 2px 2px 0 var(--ink-color);
        }
        
        .widget-title {
            border-bottom: 1px dashed var(--ink-color);
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .auto-save-setting {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 5px;
            border-top: 1px dotted var(--border-color);
            padding-top: 5px;
        }
        .auto-save-setting input[type="time"] {
            font-size: 0.9rem;
            width: 65px;
            border: 1px solid var(--border-color);
            padding: 0;
            background: transparent;
            color: var(--ink-color);
        }

        #log-list { max-height: 200px; overflow-y: auto; font-size: 0.95rem; }
        .log-item {
            display: flex; justify-content: space-between; align-items: flex-start;
            border-bottom: 1px dotted var(--border-color); padding: 3px 0; flex-wrap: wrap;
        }
        .log-info { width: 100%; display: flex; justify-content: space-between; }
        .log-actions { width: 100%; text-align: right; margin-top: 2px; opacity: 0.6; font-size: 0.8rem; }
        .log-actions span { cursor: pointer; margin-left: 8px; text-decoration: underline; padding: 5px; } 
        .log-actions span:hover { opacity: 1; font-weight: bold; }

        #weather-widget { cursor: pointer; }

        /* --- 主容器 --- */
        .container {
            width: 90%;
            max-width: 440px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-bottom: 20px;
            padding-top: 20px; 
            margin: 0 auto; 
            z-index: 100;
            position: relative;
        }

        @media (max-width: 850px) {
            .container { padding-top: 60px; }
            .left-widgets { width: auto; max-width: 80%; }
        }

        .pixel-box {
            background: var(--bg-color);
            border: 3px solid var(--border-color);
            box-shadow: var(--shadow);
            padding: 15px;
            position: relative;
        }

        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .text-btn {
            background: transparent; border: none; color: var(--ink-color);
            font-family: 'VT323'; font-size: 1.1rem; cursor: pointer; text-transform: uppercase; padding: 5px;
        }
        .text-btn:hover { text-decoration: underline; font-weight: bold; }

        .timer-display {
            font-size: 5.5rem; text-align: center; background: var(--screen-bg);
            border: 2px inset var(--border-color); margin: 10px 0; line-height: 0.9; padding: 10px 0; cursor: pointer;
        }

        .task-input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; font-size: 1.2rem; flex-wrap: wrap; }
        input[type="text"], input[type="number"], input[type="time"] {
            background: transparent; border: 2px solid var(--border-color); color: var(--ink-color);
            font-family: 'VT323'; font-size: 1.2rem; padding: 4px; outline: none; border-radius: 0;
        }
        #currentTask { flex-grow: 1; text-transform: uppercase; }
        .mode-switch { display: flex; align-items: center; cursor: pointer; font-size: 1.1rem; margin-left: 10px; padding: 5px; }

        .controls { display: flex; justify-content: center; gap: 10px; }
        button.action-btn {
            background: var(--bg-color); border: 2px solid var(--border-color); color: var(--ink-color);
            font-family: 'VT323'; font-size: 1.3rem; padding: 10px 20px;
            cursor: pointer;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.2); text-transform: uppercase;
        }
        button.action-btn:active { transform: translate(2px, 2px); box-shadow: none; }
        button.primary { background: var(--ink-color); color: var(--bg-color); }
        button.finish-btn { border-style: dashed; }

        .stats-container { display: flex; flex-direction: column; gap: 10px; background: var(--bg-color); }
        .chart-row { display: flex; align-items: center; gap: 20px; }
        #pieChartCanvas { border: 2px solid var(--border-color); border-radius: 50%; background: var(--bg-color); }
        .legend { font-size: 1rem; max-height: 120px; overflow-y: auto; width: 100%; }
        .legend-item { display: flex; justify-content: space-between; margin-bottom: 2px; border-bottom: 1px dotted var(--border-color); }

        /* Zen 模式 */
        body.zen-active .hide-in-zen { display: none !important; }
        body.zen-active .left-widgets { opacity: 0; pointer-events: none; }
        body.zen-active .container { width: 100%; max-width: none; height: 100vh; justify-content: center; padding: 0; margin: 0; }
        body.zen-active .timer-display { font-size: 25vw; border: none; background: transparent; padding: 0; margin: 0; }
        body.zen-active .pixel-box { border: none; box-shadow: none; background: transparent; }

        /* 反色模式 */
        body.break-mode { background-color: var(--invert-bg); color: var(--invert-ink); background-image: none; }
        body.break-mode .pixel-box, body.break-mode .timer-display, body.break-mode .widget-box {
            background: var(--invert-bg); border-color: var(--invert-ink); color: var(--invert-ink);
        }
        body.break-mode button { border-color: var(--invert-ink); color: var(--invert-ink); background: var(--invert-bg); }
        body.break-mode #widget-toggle-btn { background: var(--invert-bg); color: var(--invert-ink); border-color: var(--invert-ink); }
        
        .disabled-input { opacity: 0.3; pointer-events: none; }
        
        /* 状态提示 */
        #auto-save-status {
            position: fixed; bottom: 20px; right: 20px;
            background: var(--ink-color); color: var(--bg-color);
            padding: 10px 20px; font-size: 1.2rem; display: none;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3); z-index: 999;
        }
        
        /* 增加一个极小的音频播放器占位，虽然看不见但必须存在于DOM中 */
        #silent-audio { width: 1px; height: 1px; opacity: 0; position: absolute; pointer-events: none; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--ink-color); }
    </style>
</head>
<body>

<div id="auto-save-status">ARCHIVING...</div>

<audio id="silent-audio" loop playsinline>
    <source src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//oeAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV6urq6urq6urq6urq6urq6urq6urq6urq6v////////////////////////////////8AAAAATGF2YzU4LjU0AAAAAAAAAAAAAAAAJAAAAAAAAAAAASAAAAAAAQAAAAAA//oeZAAAAABAAAAAAAAAAAAAAABYaW5nAAAADwAAAAQAAAEgAIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs/////////////////////////////////wAAAABMYXZjNTguNTQAAAAAAAAAAAAAAAAkAAAAAAAAAAABIAAAAAABAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD/+h5kAAAAAEAAAAAAAABAAAAAWGluZwAAAA8AAAAEAAABIAAAAAAAAAD" type="audio/mpeg">
</audio>

<div class="left-widgets">
    <button id="widget-toggle-btn" onclick="toggleWidgets()">[ - ] WIDGETS</button>
    <div class="widget-container" id="widgetContainer">
        <div class="widget-box" id="day-countdown-widget" title="Time until End of Day"><div class="widget-title">DAY LEFT</div><div id="dayLeft" style="font-size:1.4rem; text-align:center;">--:--</div></div>
        <div class="widget-box" id="weather-widget" onclick="fetchWeather()" title="Click to refresh"><div class="widget-title">WEATHER</div><div id="weatherDisplay" style="text-align:center;">LOADING...</div></div>
        <div class="widget-box" id="log-widget"><div class="widget-title"><span>TODAY'S LOG</span><span style="font-size:0.8rem; cursor:pointer;" onclick="exportDataTxt()">[SAVE]</span></div><div id="log-list"><div style="text-align:center; color:#888;">NO RECORDS</div></div><div class="auto-save-setting" title="Auto export Log & Image daily"><span>AUTO:</span><input type="time" id="autoSaveTime" value="00:00" onchange="updateAutoSaveSetting()"></div></div>
    </div>
</div>

<div class="container">
    <div class="pixel-box hide-in-zen">
        <div class="toolbar" style="margin:0;">
            <div style="font-weight:bold; font-size:1.4rem;">E_INK_Timer</div>
            <div><button class="text-btn" onclick="toggleTheme()" title="Switch Theme">[THEME]</button><button class="text-btn" onclick="toggleZen()" title="Zen Mode">[ZEN]</button></div>
        </div>
    </div>

    <div class="pixel-box" id="timerBox">
        <div class="hide-in-zen">
            <div class="task-input-group"><span>TASK:</span><input type="text" id="currentTask" value="FOCUS" placeholder="What are you doing?"></div>
            <div class="task-input-group" style="justify-content: space-between; margin-top:10px; align-items: flex-end;">
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <div id="countdown-inputs"><span>TIME:</span><input type="number" id="workMin" value="25" style="width:50px; text-align:center"> m</div>
                    <div class="mode-switch" onclick="toggleCountUpMode()"><span id="countUpCheck">[ ]</span> COUNT UP</div>
                </div>
                <div style="text-align: right;"><div style="font-size: 0.9rem; margin-bottom: 2px;">END OF DAY:</div><input type="time" id="endOfDayTime" value="18:00" onchange="saveSettings()"></div>
            </div>
        </div>
        <div class="timer-display" id="display" onclick="toggleZen()" title="Click for Zen Mode">25:00</div>
        <div class="controls hide-in-zen">
            <button class="action-btn primary" onclick="toggleTimer()" id="mainBtn">START</button>
            <button class="action-btn finish-btn" onclick="finishEarly()" id="finishBtn" style="display:none;">DONE</button>
            <button class="action-btn" onclick="resetTimer()" id="resetBtn">RESET</button>
        </div>
    </div>

    <div class="pixel-box hide-in-zen" id="statsBox">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:2px solid var(--border-color);">
            <div style="font-weight:bold;">DAILY STATS</div><button class="text-btn" onclick="shareStatsImage()" title="Save as Image" style="font-size:0.9rem;">[SHARE IMG]</button>
        </div>
        <div style="margin-bottom:5px; font-size:0.9rem;">TOTAL FOCUS: <span id="totalTime">0</span>m | <span id="dateDisplay"></span></div>
        <div class="stats-container"><div class="chart-row"><canvas id="pieChartCanvas" width="100" height="100"></canvas><div class="legend" id="legend"><div style="text-align:center; color:#888;">NO DATA YET</div></div></div></div>
    </div>
</div>

<script>
    /* --- 全局状态 --- */
    const state = {
        timeLeft: 25 * 60, isRunning: false, isWorkMode: true, isCountUp: false, isZen: false,
        timerId: null, elapsedTime: 0, initialDuration: 0, startTimeStr: null,
        themes: ['default', 'dark', 'gameboy'], currentThemeIdx: 0,
        lastAutoSaveDate: localStorage.getItem('inkLastAutoSave') || "",
        widgetsCollapsed: false,
        // 新增：时间校准
        endTimeTarget: 0, // 目标结束时间戳 (倒计时用)
        startTimeStamp: 0, // 开始时间戳 (正计时用)
        wakeLock: null
    };

    /* --- 音频保活引用 --- */
    const silentAudio = document.getElementById('silent-audio');

    /* --- 数据 --- */
    let activityLog = JSON.parse(localStorage.getItem('inkActivityLog')) || [];
    let savedEndTime = localStorage.getItem('inkEndTime') || "18:00";
    let autoSaveTime = localStorage.getItem('inkAutoSaveTime') || "00:00";

    /* --- DOM --- */
    const els = {
        display: document.getElementById('display'), workMin: document.getElementById('workMin'),
        mainBtn: document.getElementById('mainBtn'), finishBtn: document.getElementById('finishBtn'),
        dayLeft: document.getElementById('dayLeft'), endOfDayInput: document.getElementById('endOfDayTime'),
        taskInput: document.getElementById('currentTask'), countUpCheck: document.getElementById('countUpCheck'),
        countdownInputs: document.getElementById('countdown-inputs'), weatherDisplay: document.getElementById('weatherDisplay'),
        pieCanvas: document.getElementById('pieChartCanvas'), legend: document.getElementById('legend'),
        totalTime: document.getElementById('totalTime'), dateDisplay: document.getElementById('dateDisplay'),
        statsBox: document.getElementById('statsBox'), logList: document.getElementById('log-list'),
        autoSaveInput: document.getElementById('autoSaveTime'), statusMsg: document.getElementById('auto-save-status'),
        widgetContainer: document.getElementById('widgetContainer'), widgetToggleBtn: document.getElementById('widget-toggle-btn')
    };

    els.endOfDayInput.value = savedEndTime;
    els.autoSaveInput.value = autoSaveTime;
    els.dateDisplay.textContent = new Date().toLocaleDateString();

    /* --- 0. 后台保活核心逻辑 --- */
    // 申请屏幕常亮 (Wake Lock API)
    async function requestWakeLock() {
        if ('wakeLock' in navigator) {
            try {
                state.wakeLock = await navigator.wakeLock.request('screen');
                state.wakeLock.addEventListener('release', () => { console.log('Wake Lock Released'); });
            } catch (err) { console.error(`${err.name}, ${err.message}`); }
        }
    }
    // 释放屏幕常亮
    function releaseWakeLock() {
        if (state.wakeLock !== null) {
            state.wakeLock.release();
            state.wakeLock = null;
        }
    }

    // 播放/停止静音音频
    function toggleSilentAudio(play) {
        if (play) {
            silentAudio.play().catch(e => console.log("Audio play blocked (needs user interaction first)"));
        } else {
            silentAudio.pause();
            silentAudio.currentTime = 0;
        }
    }

    /* --- 1. 组件折叠 --- */
    function toggleWidgets() { state.widgetsCollapsed = !state.widgetsCollapsed; updateWidgetState(); }
    function updateWidgetState() {
        if (state.widgetsCollapsed) { els.widgetContainer.classList.add('collapsed'); els.widgetToggleBtn.textContent = "[ + ] WIDGETS"; } 
        else { els.widgetContainer.classList.remove('collapsed'); els.widgetToggleBtn.textContent = "[ - ] WIDGETS"; }
    }
    if (window.innerWidth < 850) { state.widgetsCollapsed = true; updateWidgetState(); }

    /* --- 2. 计时器逻辑 (优化版：时间戳校准) --- */
    function toggleTimer() {
        if (state.isRunning) {
            // PAUSE
            clearInterval(state.timerId);
            state.isRunning = false;
            els.mainBtn.textContent = "RESUME";
            els.finishBtn.style.display = "none";
            toggleSilentAudio(false); // 停止音频
            releaseWakeLock(); // 释放常亮
        } else {
            // START
            // 激活保活机制
            toggleSilentAudio(true);
            requestWakeLock();

            if (!state.startTimeStr) {
                const n = new Date();
                state.startTimeStr = `${n.getHours().toString().padStart(2,'0')}:${n.getMinutes().toString().padStart(2,'0')}`;
            }

            // 设定时间锚点 (防漂移)
            if (state.isCountUp) {
                // 正计时：基于开始时间戳计算偏移
                if (state.elapsedTime === 0) { state.startTimeStamp = Date.now(); } 
                else { state.startTimeStamp = Date.now() - (state.elapsedTime * 1000); }
            } else {
                // 倒计时：计算目标结束时间
                if (state.timeLeft === els.workMin.value * 60 || state.timeLeft === 0) {
                     state.timeLeft = els.workMin.value * 60;
                     state.initialDuration = state.timeLeft;
                }
                state.endTimeTarget = Date.now() + (state.timeLeft * 1000);
            }

            state.isRunning = true;
            els.mainBtn.textContent = "PAUSE";
            els.finishBtn.style.display = "inline-block";
            
            state.timerId = setInterval(tick, 1000);
        }
    }

    function tick() {
        const now = Date.now();
        if (state.isCountUp) {
            // 正计时逻辑：当前时间 - 开始时间 = 经过时间
            const diff = now - state.startTimeStamp;
            state.elapsedTime = Math.floor(diff / 1000);
            updateDisplay(state.elapsedTime);
        } else {
            // 倒计时逻辑：目标结束时间 - 当前时间 = 剩余时间
            const diff = state.endTimeTarget - now;
            state.timeLeft = Math.ceil(diff / 1000);
            
            if (state.timeLeft <= 0) {
                state.timeLeft = 0;
                updateDisplay(0);
                finishTimer(true);
            } else {
                updateDisplay(state.timeLeft);
            }
        }
    }

    function resetTimer() {
        clearInterval(state.timerId);
        state.isRunning = false;
        
        // 停止保活
        toggleSilentAudio(false);
        releaseWakeLock();

        state.startTimeStr = null;
        state.elapsedTime = 0;
        
        els.mainBtn.textContent = "START";
        els.finishBtn.style.display = "none";
        
        if (state.isCountUp) {
            updateDisplay(0);
        } else {
            state.timeLeft = els.workMin.value * 60;
            state.initialDuration = state.timeLeft;
            updateDisplay(state.timeLeft);
        }
    }

    /* --- 3. 结束逻辑 --- */
    function finishTimer(natural) {
        clearInterval(state.timerId);
        state.isRunning = false;
        
        // 停止保活
        toggleSilentAudio(false);
        releaseWakeLock();

        els.mainBtn.textContent = "START";
        els.finishBtn.style.display = "none";
        
        let d = state.isCountUp ? Math.ceil(state.elapsedTime/60) : (natural ? Math.ceil(state.initialDuration/60) : Math.ceil((state.initialDuration-state.timeLeft)/60));
        if(d<1) d=1;
        
        if(natural) { beep(); alert("Time's Up!"); }
        
        activityLog.push({ date: new Date().toLocaleDateString(), startTime: state.startTimeStr, task: els.taskInput.value.trim()||"UNNAMED", duration: d });
        state.startTimeStr=null; state.elapsedTime=0;
        
        if(!state.isCountUp) { state.timeLeft = els.workMin.value*60; updateDisplay(state.timeLeft); } else updateDisplay(0);
        saveDataAndRender();
    }
    function finishEarly() { finishTimer(false); }
    
    /* --- 4. 其他常规逻辑 (Log, Stats, AutoSave) --- */
    // ... (以下逻辑与 v8 保持一致) ...
    function updateAutoSaveSetting() {
        autoSaveTime = els.autoSaveInput.value;
        localStorage.setItem('inkAutoSaveTime', autoSaveTime);
    }
    setInterval(() => {
        const now = new Date();
        const currentTimeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        const todayStr = now.toLocaleDateString();
        if (currentTimeStr === autoSaveTime && state.lastAutoSaveDate !== todayStr) {
            performAutoArchive(now);
        }
    }, 1000);
    async function performAutoArchive(nowDate) {
        state.lastAutoSaveDate = nowDate.toLocaleDateString();
        localStorage.setItem('inkLastAutoSave', state.lastAutoSaveDate);
        showStatus("ARCHIVING...");
        let targetDateStr = nowDate.toLocaleDateString();
        if (els.autoSaveInput.value === "00:00") {
            const yesterday = new Date(nowDate); yesterday.setDate(yesterday.getDate() - 1);
            targetDateStr = yesterday.toLocaleDateString();
        }
        renderStats(targetDateStr); renderLogWidget(targetDateStr); els.dateDisplay.textContent = targetDateStr;
        await new Promise(r => setTimeout(r, 100));
        exportDataTxt(targetDateStr);
        await shareStatsImage(targetDateStr);
        showStatus("COMPLETE"); setTimeout(() => { els.statusMsg.style.display = 'none'; }, 2000);
        const realToday = new Date().toLocaleDateString();
        renderStats(realToday); renderLogWidget(realToday); els.dateDisplay.textContent = realToday;
    }
    function showStatus(msg) { els.statusMsg.textContent = msg; els.statusMsg.style.display = 'block'; }
    function renderLogWidget(dateStr = new Date().toLocaleDateString()) {
        const logs = activityLog.map((item, index) => ({...item, originalIndex: index}))
                                .filter(item => item.date === dateStr).reverse();
        if (logs.length === 0) { els.logList.innerHTML = '<div style="text-align:center; color:#888; padding-top:10px;">NO RECORDS</div>'; return; }
        let html = '';
        logs.forEach(log => {
            html += `<div class="log-item"><div class="log-info"><span>${log.startTime||'--:--'}</span><span style="font-weight:bold;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:80px;" title="${log.task}">${log.task}</span><span>${log.duration}m</span></div><div class="log-actions"><span onclick="editLog(${log.originalIndex})">[E]</span><span onclick="deleteLog(${log.originalIndex})" style="color:red">[X]</span></div></div>`;
        });
        els.logList.innerHTML = html;
    }
    function renderStats(dateStr = new Date().toLocaleDateString()) {
        const logs = activityLog.filter(l => l.date === dateStr);
        const map = {}; let total = 0;
        logs.forEach(l => { map[l.task] = (map[l.task]||0)+l.duration; total+=l.duration; });
        els.totalTime.textContent = total;
        const ctx = els.pieCanvas.getContext('2d');
        const w = els.pieCanvas.width; const h = els.pieCanvas.height;
        ctx.clearRect(0, 0, w, h);
        if (total === 0) {
            ctx.beginPath(); ctx.arc(w/2, h/2, w/2, 0, 2*Math.PI); ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--border-color'); 
            ctx.globalAlpha = 0.2; ctx.fill(); ctx.globalAlpha = 1.0; els.legend.innerHTML = '<div style="text-align:center; color:#888;">NO DATA</div>'; return;
        }
        let startAngle = 0; let html = '';
        const inkColor = getComputedStyle(document.body).getPropertyValue('--ink-color').trim();
        const bgColor = getComputedStyle(document.body).getPropertyValue('--bg-color').trim();
        const borderColor = getComputedStyle(document.body).getPropertyValue('--border-color').trim();
        const dynamicShades = [inkColor, '#777', '#999', '#bbb', borderColor];
        Object.keys(map).forEach((k, i) => {
            const pct = map[k]/total; const sliceAngle = pct * 2 * Math.PI; const color = dynamicShades[i % dynamicShades.length];
            ctx.beginPath(); ctx.moveTo(w/2, h/2); ctx.arc(w/2, h/2, w/2, startAngle, startAngle+sliceAngle); ctx.closePath();
            ctx.fillStyle = color; ctx.fill(); ctx.lineWidth = 1; ctx.strokeStyle = bgColor; ctx.stroke();
            html += `<div class="legend-item"><div style="display:flex;align-items:center;"><span style="width:10px;height:10px;background:${color};border:1px solid var(--border-color);margin-right:5px;"></span><span>${k}</span></div><span>${map[k]}m</span></div>`;
            startAngle += sliceAngle;
        });
        els.legend.innerHTML = html;
    }
    function exportDataTxt(targetDate = null) {
        if(activityLog.length === 0) return;
        let logs = [...activityLog]; let filenameDate = new Date().toISOString().slice(0,10);
        if (targetDate) { logs = logs.filter(l => l.date === targetDate); filenameDate = targetDate.replace(/\//g, '-'); if(logs.length===0)return; }
        let txt = "=== E_INK TIMER LOG ===\n\nDATE        | START | TASK                 | DURATION\n---------------------------------------------------\n";
        logs.reverse().forEach(log => { txt += `${log.date.padEnd(11,' ')} | ${(log.startTime||"--:--").padEnd(5,' ')} | ${(log.task).padEnd(20,' ')} | ${(log.duration+"m").padEnd(8,' ')}\n`; });
        const blob = new Blob([txt], {type: 'text/plain'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `E_INK_Log_${filenameDate}.txt`; a.click();
    }
    async function shareStatsImage(suffix = null) {
        const target = els.statsBox; const border = target.style.border; target.style.border = "3px solid var(--ink-color)";
        const date = els.dateDisplay.textContent; renderStats(date);
        try {
            const canvas = await html2canvas(target, { backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-color').trim(), scale: 2 });
            target.style.border = border; const link = document.createElement('a');
            const dStr = suffix ? suffix.replace(/\//g, '-') : new Date().toISOString().slice(0, 10);
            link.download = `E_INK_Stats_${dStr}.png`; link.href = canvas.toDataURL(); link.click();
        } catch(err) { console.error(err); }
    }
    function fetchWeather() {
        els.weatherDisplay.textContent = "LOCATING...";
        if (!navigator.geolocation) { els.weatherDisplay.textContent = "NO GPS"; return; }
        navigator.geolocation.getCurrentPosition((pos) => {
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`)
                .then(res => res.json()).then(data => {
                    const codes = {0:"CLEAR",1:"CLEAR",2:"CLOUDY",3:"OVERCAST",45:"FOG",51:"RAIN",61:"RAIN",71:"SNOW",95:"STORM"};
                    els.weatherDisplay.textContent = `${Math.round(data.current_weather.temperature)}° ${codes[data.current_weather.weathercode]||"UNKNOWN"}`;
                }).catch(()=>els.weatherDisplay.textContent="ERR:NET");
        }, ()=>els.weatherDisplay.textContent="GPS DENIED");
    }
    setTimeout(fetchWeather, 1000);
    function updateDayLeft() {
        const now = new Date(); const [th, tm] = els.endOfDayInput.value.split(':').map(Number);
        const target = new Date(now); target.setHours(th, tm, 0, 0);
        let diff = target - now;
        if (diff < 0) { els.dayLeft.textContent = "FREE TIME"; els.dayLeft.style.color = "inherit"; }
        else {
            const h = Math.floor(diff/3600000); const m = Math.floor((diff%3600000)/60000);
            if(h===0) { const s = Math.floor((diff%60000)/1000); els.dayLeft.textContent = `${m}m ${s}s`; els.dayLeft.style.color = (m<30&&m%2!==0)?'var(--ink-color)':'inherit'; }
            else { els.dayLeft.textContent = `${h}h ${m}m`; els.dayLeft.style.color = 'inherit'; }
        }
    }
    setInterval(updateDayLeft, 1000);
    function saveSettings() { localStorage.setItem('inkEndTime', els.endOfDayInput.value); updateDayLeft(); }
    function deleteLog(i) { if(confirm("Delete?")) { activityLog.splice(i, 1); saveDataAndRender(); } }
    function editLog(i) {
        const l = activityLog[i]; const n = prompt("Task:", l.task); if(n===null)return;
        const d = prompt("Mins:", l.duration); if(d===null)return;
        const di = parseInt(d); if(isNaN(di)||di<1)return;
        activityLog[i].task = n.trim()||"UNNAMED"; activityLog[i].duration = di; saveDataAndRender();
    }
    function saveDataAndRender() { localStorage.setItem('inkActivityLog', JSON.stringify(activityLog)); renderLogWidget(); renderStats(); }
    function toggleCountUpMode() {
        if(state.isRunning) return; state.isCountUp = !state.isCountUp;
        els.countUpCheck.textContent = state.isCountUp ? "[x]" : "[ ]";
        if (state.isCountUp) { els.countdownInputs.classList.add('disabled-input'); updateDisplay(0); }
        else { els.countdownInputs.classList.remove('disabled-input'); updateDisplay(els.workMin.value * 60); }
    }
    function updateDisplay(s) {
        const m = Math.floor(s/60); const sec = s%60;
        els.display.textContent = `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        document.title = `(${els.display.textContent}) ${state.isRunning ? (state.isCountUp?'▲':'▼') : ''} E_INK`;
    }
    function beep() {
        const c = new (window.AudioContext||window.webkitAudioContext)(); const o = c.createOscillator(); const g = c.createGain();
        o.connect(g); g.connect(c.destination); o.type='square'; o.frequency.value=800;
        g.gain.setValueAtTime(0.1,c.currentTime); g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+0.5); o.start(); o.stop(c.currentTime+0.5);
    }
    function toggleTheme() { state.currentThemeIdx=(state.currentThemeIdx+1)%state.themes.length; document.documentElement.setAttribute('data-theme', state.themes[state.currentThemeIdx]); renderStats(); }
    function toggleZen() { state.isZen=!state.isZen; document.body.classList.toggle('zen-active', state.isZen); }
    document.addEventListener('keydown', e=>{ if(state.isZen && e.key==='Enter') toggleZen(); });

    /* --- 初始化 --- */
    renderLogWidget(); renderStats();
    els.workMin.addEventListener('change', ()=>{ if(!state.isRunning && !state.isCountUp) { state.timeLeft = els.workMin.value*60; updateDisplay(state.timeLeft); }});
</script>
</body>
</html>
